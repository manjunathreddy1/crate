import { getSP } from "./pnpjsConfig";
import { PermissionKind } from "@pnp/sp/security";
import "@pnp/sp/webs";
import "@pnp/sp/files";
import "@pnp/sp/items";

export const checkUserReadPermissionOnPage = async (pageUrl: string): Promise<boolean> => {
  try {
    const sp = getSP();

    // Get file and expand ListItemAllFields to access EffectiveBasePermissions
    const fileInfo = await sp.web.getFileByServerRelativePath(pageUrl)
      .expand("ListItemAllFields")
      .select("ListItemAllFields/EffectiveBasePermissions")
     ();

    const effectivePermissions = fileInfo?.ListItemAllFields?.EffectiveBasePermissions;

    if (!effectivePermissions) {
      console.warn("Permissions info not available.");
      return false;
    }

    const hasPermission = sp.web.hasPermissions(effectivePermissions, PermissionKind.ViewListItems);
    return hasPermission;
  } catch (error) {
    console.error("Error checking read permissions:", error);
    return false;
  }
};
